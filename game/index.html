<!doctype html>
<html>
<head>
    <title>Espace The Jail</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header>
    <h1>Escape The Jail</h1>
    <p>Escape the jail as fast as you can !</p>
</header>

<main>
    <div class="container" id="canvas-game">

        <div id="game" class="background">
            <script src="js/game.js"></script>
            <div id="buttonSkip" class="buttonSkip">
                <a onclick="skipAnimation();" target="_blank">
                    <h2>SKIP THE INTRO</h2>
                </a>
            </div>
            <img class="backbutton" src="images/backbutton.png" onclick="stopGame('abort')"/>
        </div>

        <div id="lose">
            <img class="background" src="images/background_lose.png"/>
            <img id="returnMenuButton" class="actionbutton" src="images/button-returnmenu.png" onclick="displayMenu()"/>
            <img id="restartButton" class="actionbutton" src="images/button-restart.png" onclick="restartGame()"/>
        </div>

        <div id="win">
            <img class="background" src="images/background_win.png"/>
            <img id="returnMenuButton" class="actionbutton" src="images/button-returnmenu.png" onclick="displayMenu()"/>
            <img id="saveScoreButton" class="actionbutton" src="images/button-savescore.png" onclick="displaySaveScore(getLocation)"/>
        </div>

        <div id="mainmenu">
                <img class="background" src="images/start_background.png"/>
                <img id="playButton" class="buttonmenu" src="images/button-play.png" onclick="displayLevelSelection()"/>
                <img id="rulesButton" class="buttonmenu" src="images/button-regles.png" onclick="displayRules()"/>
                <img id="hofButton" class="buttonmenu" src="images/button-score.png" onclick="displayHOF()"/>
        </div>

        <div id="saveScore" style='width: 1000px; height: 600px; border-style: solid;'>
            <img class="background" src="images/background_win.png"/>
            <img class="backbutton" src="images/backbutton.png" onclick="displayWin()"/>

            <table id="saveScoreForm">
                <tr>
                    <td><label for="name">Name</label></td>
                    <td><input id="name" type="text" class="saveScoreInput" placeholder="name"/></td>
                </tr>
                <tr>
                    <td><label for="city">City</label></td>
                    <td><input id="city" type="text" class="saveScoreInput" readonly placeholder="city"/></td>
                </tr>
                <tr><td><input type="button" id="save" value="Save !" onclick="saveScoreToFile(displayHOF)"></td></tr>
            </table>

        </div>

        <div id="levelselection">
                <img class="background" src="images/selection_background.png"/>
                <img id="hero1" class="herooption" src="images/selection_hero1.png" onclick="launchGame('level1')"/>
                <img id="hero2" class="herooption" src="images/selection_hero2.png" onclick="launchGame('level2')"/>
                <img id="hero3" class="herooption" src="images/selection_hero3.png" onclick="launchGame('level3')"/>
                <img class="backbutton" src="images/backbutton.png" onclick="displayMenu()"/>
        </div>


        <div id="rules">
                <img class="background" src="images/rules.png"/>
                <img class="backbutton" src="images/backbutton.png" onclick="displayMenu()"/>
        </div>


        <div id="hallOfFame">
                <img class="background" src="images/halloffame_background.png"/>
                <img class="backbutton" src="images/backbutton.png" onclick="displayMenu()"/>
                <table id="hof">
                </table>
        </div>

    </div>
</main>

<script src="https://cdn.jsdelivr.net/gh/bigdatacloudapi/js-reverse-geocode-client@latest/bigdatacloud_reverse_geocode.min.js" type="text/javascript"></script>
<script>
    function displayMenu(){
        document.getElementById("mainmenu").style.display = "";
        document.getElementById("game").style.display = "none";
        document.getElementById("levelselection").style.display = "none";
        document.getElementById("rules").style.display = "none";
        document.getElementById("hallOfFame").style.display = "none";
        document.getElementById("lose").style.display = "none";
        document.getElementById("win").style.display = "none";
        document.getElementById("saveScore").style.display = "none";
    }

    function displayLevelSelection (){
        document.getElementById("mainmenu").style.display = "none";
        document.getElementById("game").style.display = "none";
        document.getElementById("levelselection").style.display = "";
        document.getElementById("rules").style.display = "none";
        document.getElementById("hallOfFame").style.display = "none";
        document.getElementById("lose").style.display = "none";
        document.getElementById("win").style.display = "none";
        document.getElementById("saveScore").style.display = "none";
    }
    
    function displayRules (){
        document.getElementById("mainmenu").style.display = "none";
        document.getElementById("game").style.display = "none";
        document.getElementById("levelselection").style.display = "none";
        document.getElementById("rules").style.display = "";
        document.getElementById("hallOfFame").style.display = "none";
        document.getElementById("lose").style.display = "none";
        document.getElementById("win").style.display = "none";
        document.getElementById("saveScore").style.display = "none";
    }

    function displayHOF (){
        document.getElementById("mainmenu").style.display = "none";
        document.getElementById("game").style.display = "none";
        document.getElementById("levelselection").style.display = "none";
        document.getElementById("rules").style.display = "none";
        document.getElementById("hallOfFame").style.display = "";
        document.getElementById("lose").style.display = "none";
        document.getElementById("win").style.display = "none";
        document.getElementById("saveScore").style.display = "none";
        showHof();
    }

    function displayLose (){
        document.getElementById("mainmenu").style.display = "none";
        document.getElementById("game").style.display = "none";
        document.getElementById("levelselection").style.display = "none";
        document.getElementById("rules").style.display = "none";
        document.getElementById("hallOfFame").style.display = "none";
        document.getElementById("lose").style.display = "";
        document.getElementById("win").style.display = "none";
        document.getElementById("saveScore").style.display = "none";
    }

    function displayWin (){
        document.getElementById("mainmenu").style.display = "none";
        document.getElementById("game").style.display = "none";
        document.getElementById("levelselection").style.display = "none";
        document.getElementById("rules").style.display = "none";
        document.getElementById("hallOfFame").style.display = "none";
        document.getElementById("lose").style.display = "none";
        document.getElementById("win").style.display = "";
        document.getElementById("saveScore").style.display = "none";
    }

    function displaySaveScore(callback){
        document.getElementById("mainmenu").style.display = "none";
        document.getElementById("game").style.display = "none";
        document.getElementById("levelselection").style.display = "none";
        document.getElementById("rules").style.display = "none";
        document.getElementById("hallOfFame").style.display = "none";
        document.getElementById("lose").style.display = "none";
        document.getElementById("win").style.display = "none";
        document.getElementById("saveScore").style.display = "";
        callback();
    }

    function getLocation(){
        var reverseGeocoder=new BDCReverseGeocode();
        reverseGeocoder.localityLanguage='fr';

        reverseGeocoder.getClientLocation(function(result) {
            if(result){
                document.getElementById("city").value = result.locality + ', ' + result.countryName;
            } else {
                document.getElementById("city").value = 'Unknown';
            }
        });

    }

    function saveScoreToFile(callback){

        // scores dans le localStorage
        let dbLocalStorage = window.localStorage.getItem("escapethejail-db-hof");
        let db;
        if (dbLocalStorage == null) {
            loadHofInLocalStorage("game");
        } else {
            db = JSON.parse(dbLocalStorage);
        }

        // nom du joueur
        let name = document.getElementById("name").value;
        if(name != ""){
            let city = document.getElementById("city").value;
            // récup du temps
            let score = window.localStorage.getItem("escapethejail-score");
            let displayScore;
            var minutes = score / 60000;
            var secondes = (minutes - Math.floor(minutes)) * 60;

            if (Math.floor(secondes) < 10)
                displayScore = Math.floor(minutes) + ":0" + Math.floor(secondes);
            else
                displayScore = Math.floor(minutes) + ":" + Math.floor(secondes);


            let level = window.localStorage.getItem("escapethejail-level");
            // si on a un score à ajouter
            if (score != null) {

                // date du jour au format yyyy-mm-dd
                let m = new Date();
                let dateString =
                    m.getUTCFullYear() + "-" +
                    ("0" + (m.getUTCMonth() + 1)).slice(-2) + "-" +
                    ("0" + m.getUTCDate()).slice(-2);

                // ajout des informations du joueur dans le fichier des scores
                if (db != null) {
                    let item = {
                        name: name,
                        score: score,
                        timestamp: dateString,
                        city: city,
                        level: level,
                        displayScore: displayScore
                    };
                    db.push(item);
                }

                // écriture du fichier des scores
                window.localStorage.setItem("escapethejail-db-hof", JSON.stringify(db));

                document.getElementById("name").value='';
                document.getElementById("city").value = 'Unknown';


                // effacer les données de la parties actuelles (éviter de rajouter plusieurs fois le même score avec F5)
                window.localStorage.removeItem("escapethejail-score");
                window.localStorage.removeItem("escapethejail-level");

            } else {
                console.log("No score to process");
            }
            callback();
        }else{
            window.alert("Merci de saisir un nom");
        }

    }


    function loadHofInLocalStorage(){
    // chargement du fichier des scores (hof.db)
        let db;
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                db = JSON.parse(this.responseText);
                console.log("Base de données des scores chargée. Creating local storage copy");
                window.localStorage.setItem("escapethejail-db-hof", JSON.stringify(db));

            } else if(this.status == 404) {
                console.log("Base de données des scores introuvable.")
            }
        };
        xhttp.open("GET", "db/hof.json", false); // FALSE POUR ATTENDRE LA RÉPONSE
        xhttp.send();
    }


    function showHof(){

        document.getElementById("hof").innerText = '';

        // scores dans le localStorage
        let dbLocalStorage = window.localStorage.getItem("escapethejail-db-hof");
        let db;
        if(dbLocalStorage == null) {
            loadHofInLocalStorage();
            console.log('On créé le stockage');
        } else {
            db = JSON.parse(dbLocalStorage);
            console.log(db);
        }


        if (db != null) {
            if (db.length > 0) {
                // tri des enregistrements
                db.sort(function (b, a) {
                    return parseInt(b.score) - parseInt(a.score);
                });

                // affichage
                tableHof = document.getElementById("hof");

                // entête
                header = tableHof.createTHead();
                row = header.insertRow(-1);
                row.insertCell(0).innerHTML = "";
                row.insertCell(1).innerHTML = "Joueur"
                row.insertCell(2).innerHTML = "Ville"
                row.insertCell(3).innerHTML = "Score"
                row.insertCell(4).innerHTML = "Date"

                body = tableHof.createTBody();

                var db_level1 = [];
                var db_level2 = [];
                var db_level3 = [];
                var i1= 0;
                var i2= 0;
                var i3= 0;

                for (var line in db) {

                    if(i1<3 && db[line].level==1){
                        db_level1[i1]=db[line];
                        i1++;
                    }
                    else if(i2<3 && db[line].level==2){
                        db_level2[i2]=db[line];
                        i2++;
                    }
                    else if(i3<3 && db[line].level==3){
                        db_level3[i3]=db[line];
                        i3++;
                    }

                }

                var name_reduced;

                if(db_level1.length>0){
                    row = body.insertRow(-1);
                    row.insertCell(0).innerHTML = 'Niveau 1';
                    row.className='level';
                    for (var line in db_level1) {
                        row = body.insertRow(-1);
                        row.insertCell(0).innerHTML = (+line+1);
                        name_reduced = db_level1[line].name.substring(0,15);
                        row.insertCell(1).innerHTML = name_reduced;
                        row.insertCell(2).innerHTML = db_level1[line].city;
                        row.insertCell(3).innerHTML = db_level1[line].displayScore;
                        row.insertCell(4).innerHTML = db_level1[line].timestamp;
                    }
                }

                if(db_level2.length>0){
                    row = body.insertRow(-1);
                    row.insertCell(0).innerHTML = 'Niveau 2';
                    row.className='level';
                    for (var line in db_level2) {
                        row = body.insertRow(-1);
                        row.insertCell(0).innerHTML = (+line+1);
                        name_reduced = db_level2[line].name.substring(0,15);
                        row.insertCell(1).innerHTML = name_reduced;
                        row.insertCell(2).innerHTML = db_level2[line].city;
                        row.insertCell(3).innerHTML = db_level2[line].displayScore;
                        row.insertCell(4).innerHTML = db_level2[line].timestamp;
                    }
                }

                if(db_level3.length>0){
                    row = body.insertRow(-1);
                    row.insertCell(0).innerHTML = 'Niveau 3';
                    row.className='level';
                    for (var line in db_level3) {
                        row = body.insertRow(-1);
                        row.insertCell(0).innerHTML = (+line+1);
                        name_reduced = db_level3[line].name.substring(0,15);
                        row.insertCell(1).innerHTML = name_reduced;
                        row.insertCell(2).innerHTML = db_level3[line].city;
                        row.insertCell(3).innerHTML = db_level3[line].displayScore;
                        row.insertCell(4).innerHTML = db_level3[line].timestamp;
                    }
                }
            } else {
                document.getElementById("hof").innerText = "Pas de scores à afficher";
            }
        }
    }

    window.onload = displayMenu;

</script>

</body>
</html>
